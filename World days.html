<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>地図UI付きワールドクロック（geo-tz ESM版）</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <style>
    html,body { margin:0; padding:0; height:100% }
    body { display:flex; flex-direction:column }
    #map { flex:1 }
    #panel {
      height:150px;
      overflow-y:auto;
      padding:0.5rem;
      background:#f8f8f8;
      border-top:1px solid #ccc;
      font-family:sans-serif;
    }
    .clock-box {
      display:inline-block;
      width:180px;
      margin:0.3rem;
      padding:0.4rem;
      background:#fff;
      border:1px solid #ddd;
      border-radius:4px;
      text-align:center;
      font-family:sans-serif;
    }
    .clock-box h4 { margin:0 0 .2em; font-size:0.9rem }
    .time { font-size:1.2rem }
    .sun .time { color:#e74c3c }
    .mon .time { color:#3498db }
    .tue .time { color:#2ecc71 }
    .wed .time { color:#9b59b6 }
    .thu .time { color:#f1c40f }
    .fri .time { color:#e67e22 }
    .sat .time { color:#1abc9c }
    .holiday { font-weight:bold; }
  </style>
</head>
<body>

  <div id="map"></div>
  <div id="panel">
    <em>地図をクリックしてタイムゾーンを追加してください。</em>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- メインスクリプトを type=module で書きます -->
  <script type="module">
    import geoTz from 'https://cdn.jsdelivr.net/npm/geo-tz@6.2.0/esm/index.js';

    const WEEK_JP   = ['日','月','火','水','木','金','土'];
    const WEEK_CLS  = ['sun','mon','tue','wed','thu','fri','sat'];
    const panel     = document.getElementById('panel');
    const zones     = {};

    // 祝日API用の ISO 国コードマップ
    const TZ2CC = {
      'Asia/Tokyo':       'JP',
      'Asia/Kolkata':     'IN',
      'Africa/Cairo':     'EG',
      'America/New_York': 'US'
    };

    // Leaflet マップ初期化
    const map = L.map('map', {
      center: [20,0], zoom:2, attributionControl:false
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:5, minZoom:1
    }).addTo(map);

    // クリックでタイムゾーン追加
    map.on('click', async e => {
      // geo-tz の ESM 関数を使って緯度経度から tz を取得
      const tzas = geoTz(e.latlng.lat, e.latlng.lng);
      if (!tzas || !tzas.length) return;
      const tz = tzas[0];
      if (zones[tz]) return;

      // GMTオフセット文字列（DST込み）を Intl で取得
      const off = Intl.DateTimeFormat('en', {
        timeZone: tz, timeZoneName: 'short'
      }).format(new Date()).split(' ').pop();

      // 日付フォーマッタ
      const fmt = new Intl.DateTimeFormat('ja-JP', {
        timeZone:  tz,
        year:      'numeric',
        month:     'numeric',
        day:       'numeric',
        hour:      'numeric',
        minute:    'numeric',
        weekday:   'short'
      });

      // 祝日を Nager.Date API から取得
      let holidays = null;
      const cc = TZ2CC[tz];
      if (cc) {
        try {
          const year = new Date().getFullYear();
          const res  = await fetch(
            `https://date.nager.at/api/v3/PublicHolidays/${year}/${cc}`
          );
          if (res.ok) {
            const arr = await res.json();
            holidays = arr.map(h => {
              const d = new Date(h.date);
              return String(d.getMonth()+1).padStart(2,'0')
                   + '-' + String(d.getDate()).padStart(2,'0');
            });
          }
        } catch {}
      }

      zones[tz] = { fmt, holidays };

      // マーカー＋ポップアップでフィードバック
      L.marker([e.latlng.lat, e.latlng.lng])
       .addTo(map)
       .bindPopup(`<b>${tz}</b><br>${off}`)
       .openPopup();

      // 時計ボックスを追加
      const id = 'box_' + tz.replace(/[^A-Za-z0-9]/g,'_');
      const box = document.createElement('div');
      box.id = id;
      box.className = 'clock-box';
      box.innerHTML = `<h4>${tz} (${off})</h4><div class="time">読み込み中…</div>`;
      panel.appendChild(box);

      updateAll(true);
    });

    let last = {};
    function updateAll(force){
      const now = new Date();
      for (const [tz, z] of Object.entries(zones)) {
        const parts = z.fmt.formatToParts(now);
        const p = {}; parts.forEach(o => p[o.type] = o.value);
        const text = 
          `${p.year}年${p.month}月${p.day}日(${p.weekday}) `
          + `${p.hour}時${p.minute}分`;

        if (force || last[tz] !== text) {
          last[tz] = text;
          const box    = document.getElementById(
            'box_' + tz.replace(/[^A-Za-z0-9]/g,'_')
          );
          const timeEl = box.querySelector('.time');
          timeEl.textContent = text;

          // 曜日で色分け
          const wd = WEEK_JP.indexOf(p.weekday);
          box.className = 'clock-box ' + WEEK_CLS[wd];

          // 祝日ハイライト
          if (z.holidays) {
            const mmdd = p.month.padStart(2,'0') + '-' + p.day.padStart(2,'0');
            timeEl.classList.toggle('holiday', z.holidays.includes(mmdd));
          }
        }
      }
    }

    // 1秒ごとに更新
    setInterval(() => updateAll(false), 1000);
  </script>
</body>
</html>
